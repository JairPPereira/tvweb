{"version":3,"sources":["../../../../../src/streaming/models/MediaPlayerModel.js"],"names":["DEFAULT_MIN_BUFFER_TIME","DEFAULT_MIN_BUFFER_TIME_FAST_SWITCH","DEFAULT_LOW_LATENCY_LIVE_DELAY","LOW_LATENCY_REDUCTION_FACTOR","LOW_LATENCY_MULTIPLY_FACTOR","DEFAULT_XHR_WITH_CREDENTIALS","MediaPlayerModel","instance","UTCTimingSources","xhrWithCredentials","customABRRule","DEFAULT_UTC_TIMING_SOURCE","scheme","value","context","settings","getInstance","setup","default","findABRCustomRuleIndex","rulename","i","length","getABRCustomRules","addABRCustomRule","type","rule","ABRRulesCollection","ABANDON_FRAGMENT_RULES","QUALITY_SWITCH_RULES","Constants","BAD_ARGUMENT_ERROR","index","push","removeABRCustomRule","splice","getStableBufferTime","get","streaming","lowLatencyEnabled","getLiveDelay","stableBufferTime","fastSwitchEnabled","getRetryAttemptsForType","retryAttempts","getRetryIntervalsForType","retryIntervals","liveDelay","addUTCTimingSource","schemeIdUri","removeUTCTimingSource","vo","UTCTiming","getUTCTimingSources","forEach","obj","idx","clearDefaultUTCTimingSources","restoreDefaultUTCTimingSources","setXHRWithCredentialsForType","Object","keys","key","getXHRWithCredentialsForType","useCreds","undefined","getDefaultUtcTimingSource","reset","__dashjs_factory_name","FactoryMaker","getSingletonFactory"],"mappings":"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","file":"MediaPlayerModel.js","sourcesContent":["/**\n * The copyright in this software is being made available under the BSD License,\n * included below. This software may be subject to other third party and contributor\n * rights, including patent rights, and no such rights are granted under this license.\n *\n * Copyright (c) 2013, Dash Industry Forum.\n * All rights reserved.\n *\n * Redistribution and use in source and binary forms, with or without modification,\n * are permitted provided that the following conditions are met:\n *  * Redistributions of source code must retain the above copyright notice, this\n *  list of conditions and the following disclaimer.\n *  * Redistributions in binary form must reproduce the above copyright notice,\n *  this list of conditions and the following disclaimer in the documentation and/or\n *  other materials provided with the distribution.\n *  * Neither the name of Dash Industry Forum nor the names of its\n *  contributors may be used to endorse or promote products derived from this software\n *  without specific prior written permission.\n *\n *  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS AS IS AND ANY\n *  EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\n *  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.\n *  IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,\n *  INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT\n *  NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR\n *  PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,\n *  WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)\n *  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE\n *  POSSIBILITY OF SUCH DAMAGE.\n */\nimport UTCTiming from '../../dash/vo/UTCTiming';\nimport FactoryMaker from '../../core/FactoryMaker';\nimport Constants from '../constants/Constants';\nimport ABRRulesCollection from '../rules/abr/ABRRulesCollection';\nimport Settings from '../../core/Settings';\nimport { checkParameterType} from '../utils/SupervisorTools';\n\n\nconst DEFAULT_MIN_BUFFER_TIME = 12;\nconst DEFAULT_MIN_BUFFER_TIME_FAST_SWITCH = 20;\n\nconst DEFAULT_LOW_LATENCY_LIVE_DELAY = 3.0;\nconst LOW_LATENCY_REDUCTION_FACTOR = 10;\nconst LOW_LATENCY_MULTIPLY_FACTOR = 5;\n\nconst DEFAULT_XHR_WITH_CREDENTIALS = false;\n\nfunction MediaPlayerModel() {\n\n    let instance,\n        UTCTimingSources,\n        xhrWithCredentials,\n        customABRRule;\n\n    const DEFAULT_UTC_TIMING_SOURCE = {\n            scheme: 'urn:mpeg:dash:utc:http-xsdate:2014',\n            value: 'http://time.akamai.com/?iso&ms'\n        };\n    const context = this.context;\n    const settings = Settings(context).getInstance();\n\n    function setup() {\n        UTCTimingSources = [];\n        xhrWithCredentials = {\n            default: DEFAULT_XHR_WITH_CREDENTIALS\n        };\n        customABRRule = [];\n    }\n\n    //TODO Should we use Object.define to have setters/getters? makes more readable code on other side.\n    function findABRCustomRuleIndex(rulename) {\n        let i;\n        for (i = 0; i < customABRRule.length; i++) {\n            if (customABRRule[i].rulename === rulename) {\n                return i;\n            }\n        }\n        return -1;\n    }\n\n    function getABRCustomRules() {\n        return customABRRule;\n    }\n\n    function addABRCustomRule(type, rulename, rule) {\n        if (typeof type !== 'string' || (type !== ABRRulesCollection.ABANDON_FRAGMENT_RULES && type !== ABRRulesCollection.QUALITY_SWITCH_RULES) ||\n            typeof rulename !== 'string') {\n            throw Constants.BAD_ARGUMENT_ERROR;\n        }\n        let index = findABRCustomRuleIndex(rulename);\n        if (index === -1) {\n            // add rule\n            customABRRule.push({\n                type: type,\n                rulename: rulename,\n                rule: rule\n            });\n        } else {\n            // update rule\n            customABRRule[index].type = type;\n            customABRRule[index].rule = rule;\n        }\n    }\n\n    function removeABRCustomRule(rulename) {\n        if (rulename) {\n            let index = findABRCustomRuleIndex(rulename);\n            //if no rulename custom rule has been found, do nothing\n            if (index !== -1) {\n                // remove rule\n                customABRRule.splice(index, 1);\n            }\n        } else {\n            //if no rulename is defined, remove all ABR custome rules\n            customABRRule = [];\n        }\n    }\n\n    function getStableBufferTime() {\n        if (settings.get().streaming.lowLatencyEnabled) {\n            return getLiveDelay() * 0.6;\n        }\n\n        const stableBufferTime = settings.get().streaming.stableBufferTime;\n        return stableBufferTime > -1 ? stableBufferTime : settings.get().streaming.fastSwitchEnabled ? DEFAULT_MIN_BUFFER_TIME_FAST_SWITCH : DEFAULT_MIN_BUFFER_TIME;\n    }\n\n    function getRetryAttemptsForType(type) {\n        return settings.get().streaming.lowLatencyEnabled ? settings.get().streaming.retryAttempts[type] * LOW_LATENCY_MULTIPLY_FACTOR : settings.get().streaming.retryAttempts[type];\n    }\n\n    function getRetryIntervalsForType(type) {\n        return settings.get().streaming.lowLatencyEnabled ? settings.get().streaming.retryIntervals[type] / LOW_LATENCY_REDUCTION_FACTOR : settings.get().streaming.retryIntervals[type];\n    }\n\n    function getLiveDelay() {\n        if (settings.get().streaming.lowLatencyEnabled) {\n            return settings.get().streaming.liveDelay || DEFAULT_LOW_LATENCY_LIVE_DELAY;\n        }\n        return settings.get().streaming.liveDelay;\n    }\n\n    function addUTCTimingSource(schemeIdUri, value) {\n        removeUTCTimingSource(schemeIdUri, value); //check if it already exists and remove if so.\n        let vo = new UTCTiming();\n        vo.schemeIdUri = schemeIdUri;\n        vo.value = value;\n        UTCTimingSources.push(vo);\n    }\n\n    function getUTCTimingSources() {\n        return UTCTimingSources;\n    }\n\n    function removeUTCTimingSource(schemeIdUri, value) {\n        checkParameterType(schemeIdUri, 'string');\n        checkParameterType(value, 'string');\n        UTCTimingSources.forEach(function (obj, idx) {\n            if (obj.schemeIdUri === schemeIdUri && obj.value === value) {\n                UTCTimingSources.splice(idx, 1);\n            }\n        });\n    }\n\n    function clearDefaultUTCTimingSources() {\n        UTCTimingSources = [];\n    }\n\n    function restoreDefaultUTCTimingSources() {\n        addUTCTimingSource(DEFAULT_UTC_TIMING_SOURCE.scheme, DEFAULT_UTC_TIMING_SOURCE.value);\n    }\n\n    function setXHRWithCredentialsForType(type, value) {\n        if (!type) {\n            Object.keys(xhrWithCredentials).forEach(key => {\n                setXHRWithCredentialsForType(key, value);\n            });\n        } else {\n            xhrWithCredentials[type] = !!value;\n        }\n    }\n\n    function getXHRWithCredentialsForType(type) {\n        const useCreds = xhrWithCredentials[type];\n\n        return useCreds === undefined ? xhrWithCredentials.default : useCreds;\n    }\n\n    function getDefaultUtcTimingSource() {\n        return DEFAULT_UTC_TIMING_SOURCE;\n    }\n\n    function reset() {\n        //TODO need to figure out what props to persist across sessions and which to reset if any.\n        //setup();\n    }\n\n    instance = {\n        getABRCustomRules: getABRCustomRules,\n        addABRCustomRule: addABRCustomRule,\n        removeABRCustomRule: removeABRCustomRule,\n        getStableBufferTime: getStableBufferTime,\n        getRetryAttemptsForType: getRetryAttemptsForType,\n        getRetryIntervalsForType: getRetryIntervalsForType,\n        getLiveDelay: getLiveDelay,\n        addUTCTimingSource: addUTCTimingSource,\n        removeUTCTimingSource: removeUTCTimingSource,\n        getUTCTimingSources: getUTCTimingSources,\n        clearDefaultUTCTimingSources: clearDefaultUTCTimingSources,\n        restoreDefaultUTCTimingSources: restoreDefaultUTCTimingSources,\n        setXHRWithCredentialsForType: setXHRWithCredentialsForType,\n        getXHRWithCredentialsForType: getXHRWithCredentialsForType,\n        getDefaultUtcTimingSource: getDefaultUtcTimingSource,\n        reset: reset\n    };\n\n    setup();\n\n    return instance;\n}\n\n//TODO see if you can move this and not export and just getter to get default value.\nMediaPlayerModel.__dashjs_factory_name = 'MediaPlayerModel';\nexport default FactoryMaker.getSingletonFactory(MediaPlayerModel);"]}