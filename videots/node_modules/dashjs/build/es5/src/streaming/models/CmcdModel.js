'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _EventBus=require('../../core/EventBus');var _EventBus2=_interopRequireDefault(_EventBus);var _MediaPlayerEvents=require('../MediaPlayerEvents');var _MediaPlayerEvents2=_interopRequireDefault(_MediaPlayerEvents);var _FactoryMaker=require('../../core/FactoryMaker');var _FactoryMaker2=_interopRequireDefault(_FactoryMaker);var _Debug=require('../../core/Debug');var _Debug2=_interopRequireDefault(_Debug);var _Settings=require('../../core/Settings');var _Settings2=_interopRequireDefault(_Settings);var _HTTPRequest=require('../vo/metrics/HTTPRequest');var _DashManifestModel=require('../../dash/models/DashManifestModel');var _DashManifestModel2=_interopRequireDefault(_DashManifestModel);var _Utils=require('../../core/Utils');var _Utils2=_interopRequireDefault(_Utils);var _Version=require('../../core/Version');function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var CMCD_REQUEST_FIELD_NAME='Common-Media-Client-Data';/**
 * The copyright in this software is being made available under the BSD License,
 * included below. This software may be subject to other third party and contributor
 * rights, including patent rights, and no such rights are granted under this license.
 *
 * Copyright (c) 2013, Dash Industry Forum.
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without modification,
 * are permitted provided that the following conditions are met:
 *  * Redistributions of source code must retain the above copyright notice, this
 *  list of conditions and the following disclaimer.
 *  * Redistributions in binary form must reproduce the above copyright notice,
 *  this list of conditions and the following disclaimer in the documentation and/or
 *  other materials provided with the distribution.
 *  * Neither the name of Dash Industry Forum nor the names of its
 *  contributors may be used to endorse or promote products derived from this software
 *  without specific prior written permission.
 *
 *  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS AS IS AND ANY
 *  EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 *  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
 *  IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,
 *  INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT
 *  NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 *  PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
 *  WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 *  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
 *  POSSIBILITY OF SUCH DAMAGE.
 */var CMCD_VERSION=1;var DEFAULT_DEVICE_ID='dash.js-v'+(0,_Version.getVersionString)();var BUFFER_STATES={DEFAULT:null,INITIALIZING:1,SEEKING:2,RISK:3,EMPTY:4};var OBJECT_TYPES={MANIFEST:'m',AUDIO:'a',VIDEO:'v',INIT:'i',CAPTION:'c'};var STREAMING_FORMATS={DASH:'d',MSS:'s'};var STREAM_TYPES={VOD:'v',LIVE:'l'};function CmcdModel(){var logger=void 0,dashManifestModel=void 0,instance=void 0,internalData=void 0,abrController=void 0,dashMetrics=void 0,playbackController=void 0;var context=this.context;var eventBus=(0,_EventBus2.default)(context).getInstance();var settings=(0,_Settings2.default)(context).getInstance();function setup(){logger=(0,_Debug2.default)(context).getInstance().getLogger(instance);dashManifestModel=(0,_DashManifestModel2.default)(context).getInstance();_resetInitialSettings();}function initialize(){eventBus.on(_MediaPlayerEvents2.default.PLAYBACK_RATE_CHANGED,_onPlaybackRateChanged,instance);eventBus.on(_MediaPlayerEvents2.default.MANIFEST_LOADED,_onManifestLoaded,instance);eventBus.on(_MediaPlayerEvents2.default.BUFFER_LEVEL_STATE_CHANGED,_onBufferLevelStateChanged,instance);}function setConfig(config){if(!config)return;if(config.abrController){abrController=config.abrController;}if(config.dashMetrics){dashMetrics=config.dashMetrics;}if(config.playbackController){playbackController=config.playbackController;}}function _resetInitialSettings(){internalData={pr:1,nor:null,st:null,sf:null,sid:''+_Utils2.default.generateUuid(),bs:{audio:BUFFER_STATES.INITIALIZING,video:BUFFER_STATES.INITIALIZING},cid:null,did:''+DEFAULT_DEVICE_ID};}function getQueryParameter(request){try{if(settings.get().streaming.cmcd&&settings.get().streaming.cmcd.enabled){var cmcdData=_getCmcdData(request);var finalPayloadString=_buildFinalString(cmcdData);return{key:CMCD_REQUEST_FIELD_NAME,value:finalPayloadString};}return null;}catch(e){return null;}}function _getCmcdData(request){try{var cmcdData=null;if(request.type===_HTTPRequest.HTTPRequest.MPD_TYPE){_setDefaultContentId(request);return _getCmcdDataForMpd(request);}else if(request.type===_HTTPRequest.HTTPRequest.MEDIA_SEGMENT_TYPE){return _getCmcdDataForMediaSegment(request);}else if(request.type===_HTTPRequest.HTTPRequest.INIT_SEGMENT_TYPE){return _getCmcdDataForInitSegment(request);}return cmcdData;}catch(e){return null;}}function _setDefaultContentId(request){try{internalData.cid=''+_Utils2.default.generateHashCode(request.url);}catch(e){}}function _getCmcdDataForMpd(){var data=_getGenericCmcdData();data.ot=''+OBJECT_TYPES.MANIFEST;return data;}function _getCmcdDataForMediaSegment(request){var data=_getGenericCmcdData();var encodedBitrate=_getBitrateByRequest(request);var d=_getObjectDurationByRequest(request);var ot=request.mediaType==='video'?''+OBJECT_TYPES.VIDEO:request.mediaType==='audio'?''+OBJECT_TYPES.AUDIO:request.mediaType==='fragmentedText'?''+OBJECT_TYPES.CAPTION:null;var mtp=_getMeasuredThroughputByType(request.mediaType);var dl=_getDeadlineByType(request.mediaType);var bs=_getBufferStateByRequest(request);if(encodedBitrate){data.br=encodedBitrate;}if(ot){data.ot=ot;}if(!isNaN(d)){data.d=d;}if(!isNaN(mtp)){data.mtp=mtp;}if(!isNaN(dl)){data.dl=dl;}if(!isNaN(bs)&&bs!==null){data.bs=bs;}return data;}function _getCmcdDataForInitSegment(){var data=_getGenericCmcdData();data.ot=''+OBJECT_TYPES.INIT;return data;}function _getGenericCmcdData(){var data={};data.v=CMCD_VERSION;data.sid=settings.get().streaming.cmcd.sid?settings.get().streaming.cmcd.sid:internalData.sid;data.cid=settings.get().streaming.cmcd.cid?settings.get().streaming.cmcd.cid:internalData.cid;data.did=settings.get().streaming.cmcd.did?settings.get().streaming.cmcd.did:internalData.did;data.sid='"'+data.sid+'"';data.cid='"'+data.cid+'"';data.did='"'+data.did+'"';if(!isNaN(internalData.pr)&&internalData.pr!==1&&internalData.pr!==null){data.pr=internalData.pr;}if(internalData.st){data.st=internalData.st;}if(internalData.sf){data.sf=internalData.sf;}return data;}function _getBitrateByRequest(request){try{var quality=request.quality;var bitrateList=request.mediaInfo.bitrateList;return parseInt(bitrateList[quality].bandwidth/1000);}catch(e){return null;}}function _getObjectDurationByRequest(request){try{return!isNaN(request.duration)?Math.round(request.duration*1000):null;}catch(e){return null;}}function _getMeasuredThroughputByType(mediaType){try{return Math.round(abrController.getThroughputHistory().getSafeAverageThroughput(mediaType));}catch(e){return null;}}function _getDeadlineByType(mediaType){try{var playbackRate=internalData.pr;var bufferLevel=dashMetrics.getCurrentBufferLevel(mediaType,true);if(!isNaN(playbackRate)&&!isNaN(bufferLevel)){return parseInt(bufferLevel/playbackRate*1000);}return null;}catch(e){return null;}}function _getBufferStateByRequest(request){try{var mediaType=request.mediaType;if(internalData.bs[mediaType]!==null){return internalData.bs[mediaType];}var bufferLevel=dashMetrics.getCurrentBufferLevel(mediaType,true);var duration=request.duration;if(bufferLevel<duration){return BUFFER_STATES.RISK;}return BUFFER_STATES.DEFAULT;}catch(e){}}function _onPlaybackRateChanged(data){try{internalData.pr=data.playbackRate;}catch(e){}}function _onManifestLoaded(data){try{var isDynamic=dashManifestModel.getIsDynamic(data.data);var st=isDynamic?''+STREAM_TYPES.LIVE:''+STREAM_TYPES.VOD;var sf=data.protocol&&data.protocol==='MSS'?''+STREAMING_FORMATS.MSS:''+STREAMING_FORMATS.DASH;internalData.st=''+st;internalData.sf=''+sf;}catch(e){}}function _onBufferLevelStateChanged(data){try{if(data.state&&data.mediaType){var state=null;switch(data.state){case _MediaPlayerEvents2.default.BUFFER_LOADED:state=BUFFER_STATES.DEFAULT;break;case _MediaPlayerEvents2.default.BUFFER_EMPTY:if(playbackController.isSeeking()){state=BUFFER_STATES.SEEKING;}state=BUFFER_STATES.EMPTY;break;default:}internalData.bs[data.mediaType]=state;}}catch(e){}}function _buildFinalString(cmcdData){try{if(!cmcdData){return null;}var keys=Object.keys(cmcdData);var length=keys.length;return keys.reduce(function(acc,key,index){acc+=key+'='+cmcdData[key];if(index<length-1){acc+=',';}return acc;},'');}catch(e){return null;}}function reset(){eventBus.off(_MediaPlayerEvents2.default.PLAYBACK_RATE_CHANGED,_onPlaybackRateChanged,this);eventBus.off(_MediaPlayerEvents2.default.MANIFEST_LOADED,_onManifestLoaded,this);eventBus.off(_MediaPlayerEvents2.default.BUFFER_LEVEL_STATE_CHANGED,_onBufferLevelStateChanged,instance);_resetInitialSettings();}instance={getQueryParameter:getQueryParameter,setConfig:setConfig,reset:reset,initialize:initialize};setup();return instance;}CmcdModel.__dashjs_factory_name='CmcdModel';exports.default=_FactoryMaker2.default.getSingletonFactory(CmcdModel);
//# sourceMappingURL=CmcdModel.js.map
