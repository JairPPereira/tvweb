{"version":3,"sources":["../../../../src/streaming/ManifestUpdater.js"],"names":["ManifestUpdater","context","eventBus","getInstance","instance","logger","refreshDelay","refreshTimer","isPaused","isUpdating","manifestLoader","manifestModel","adapter","errHandler","settings","setup","getLogger","setConfig","config","initialize","resetInitialSettings","on","Events","STREAMS_COMPOSED","onStreamsComposed","PLAYBACK_STARTED","onPlaybackStarted","PLAYBACK_PAUSED","onPlaybackPaused","INTERNAL_MANIFEST_LOADED","onManifestLoaded","setManifest","manifest","update","NaN","stopManifestRefreshTimer","reset","off","clearTimeout","startManifestRefreshTimer","delay","isNaN","debug","setTimeout","onRefreshTimer","refreshManifest","getValue","url","location","getLocation","load","setValue","date","Date","latencyOfLastUpdate","getTime","loadedTime","getManifestUpdatePeriod","trigger","MANIFEST_UPDATED","info","get","streaming","scheduleWhilePaused","manifestUpdateRetryInterval","e","error","code","Errors","MANIFEST_LOADER_PARSING_FAILURE_ERROR_CODE","__dashjs_factory_name","FactoryMaker","getClassFactory"],"mappings":"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","file":"ManifestUpdater.js","sourcesContent":["/**\n * The copyright in this software is being made available under the BSD License,\n * included below. This software may be subject to other third party and contributor\n * rights, including patent rights, and no such rights are granted under this license.\n *\n * Copyright (c) 2013, Dash Industry Forum.\n * All rights reserved.\n *\n * Redistribution and use in source and binary forms, with or without modification,\n * are permitted provided that the following conditions are met:\n *  * Redistributions of source code must retain the above copyright notice, this\n *  list of conditions and the following disclaimer.\n *  * Redistributions in binary form must reproduce the above copyright notice,\n *  this list of conditions and the following disclaimer in the documentation and/or\n *  other materials provided with the distribution.\n *  * Neither the name of Dash Industry Forum nor the names of its\n *  contributors may be used to endorse or promote products derived from this software\n *  without specific prior written permission.\n *\n *  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS AS IS AND ANY\n *  EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\n *  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.\n *  IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,\n *  INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT\n *  NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR\n *  PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,\n *  WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)\n *  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE\n *  POSSIBILITY OF SUCH DAMAGE.\n */\nimport EventBus from '../core/EventBus';\nimport Events from '../core/events/Events';\nimport FactoryMaker from '../core/FactoryMaker';\nimport Debug from '../core/Debug';\nimport Errors from '../core/errors/Errors';\n\nfunction ManifestUpdater() {\n\n    const context = this.context;\n    const eventBus = EventBus(context).getInstance();\n\n    let instance,\n        logger,\n        refreshDelay,\n        refreshTimer,\n        isPaused,\n        isUpdating,\n        manifestLoader,\n        manifestModel,\n        adapter,\n        errHandler,\n        settings;\n\n    function setup() {\n        logger = Debug(context).getInstance().getLogger(instance);\n    }\n\n    function setConfig(config) {\n        if (!config) return;\n\n        if (config.manifestModel) {\n            manifestModel = config.manifestModel;\n        }\n        if (config.adapter) {\n            adapter = config.adapter;\n        }\n        if (config.manifestLoader) {\n            manifestLoader = config.manifestLoader;\n        }\n        if (config.errHandler) {\n            errHandler = config.errHandler;\n        }\n        if (config.settings) {\n            settings = config.settings;\n        }\n    }\n\n    function initialize() {\n        resetInitialSettings();\n\n        eventBus.on(Events.STREAMS_COMPOSED, onStreamsComposed, this);\n        eventBus.on(Events.PLAYBACK_STARTED, onPlaybackStarted, this);\n        eventBus.on(Events.PLAYBACK_PAUSED, onPlaybackPaused, this);\n        eventBus.on(Events.INTERNAL_MANIFEST_LOADED, onManifestLoaded, this);\n    }\n\n    function setManifest(manifest) {\n        update(manifest);\n    }\n\n    function resetInitialSettings() {\n        refreshDelay = NaN;\n        isUpdating = false;\n        isPaused = true;\n        stopManifestRefreshTimer();\n    }\n\n    function reset() {\n\n        eventBus.off(Events.PLAYBACK_STARTED, onPlaybackStarted, this);\n        eventBus.off(Events.PLAYBACK_PAUSED, onPlaybackPaused, this);\n        eventBus.off(Events.STREAMS_COMPOSED, onStreamsComposed, this);\n        eventBus.off(Events.INTERNAL_MANIFEST_LOADED, onManifestLoaded, this);\n\n        resetInitialSettings();\n    }\n\n    function stopManifestRefreshTimer() {\n        if (refreshTimer !== null) {\n            clearTimeout(refreshTimer);\n            refreshTimer = null;\n        }\n    }\n\n    function startManifestRefreshTimer(delay) {\n        stopManifestRefreshTimer();\n\n        if (isNaN(delay) && !isNaN(refreshDelay)) {\n            delay = refreshDelay * 1000;\n        }\n\n        if (!isNaN(delay)) {\n            logger.debug('Refresh manifest in ' + delay + ' milliseconds.');\n            refreshTimer = setTimeout(onRefreshTimer, delay);\n        }\n    }\n\n    function refreshManifest() {\n        isUpdating = true;\n        const manifest = manifestModel.getValue();\n        let url = manifest.url;\n        const location = adapter.getLocation(manifest);\n        if (location) {\n            url = location;\n        }\n        manifestLoader.load(url);\n    }\n\n    function update(manifest) {\n\n        manifestModel.setValue(manifest);\n\n        const date = new Date();\n        const latencyOfLastUpdate = (date.getTime() - manifest.loadedTime.getTime()) / 1000;\n        refreshDelay = adapter.getManifestUpdatePeriod(manifest, latencyOfLastUpdate);\n        // setTimeout uses a 32 bit number to store the delay. Any number greater than it\n        // will cause event associated with setTimeout to trigger immediately\n        if (refreshDelay * 1000 > 0x7FFFFFFF) {\n            refreshDelay = 0x7FFFFFFF / 1000;\n        }\n        eventBus.trigger(Events.MANIFEST_UPDATED, {manifest: manifest});\n        logger.info('Manifest has been refreshed at ' + date + '[' + date.getTime() / 1000 + '] ');\n\n        if (!isPaused) {\n            startManifestRefreshTimer();\n        }\n    }\n\n    function onRefreshTimer() {\n        if (isPaused && !settings.get().streaming.scheduleWhilePaused) {\n            return;\n        }\n        if (isUpdating) {\n            startManifestRefreshTimer(settings.get().streaming.manifestUpdateRetryInterval);\n            return;\n        }\n        refreshManifest();\n    }\n\n    function onManifestLoaded(e) {\n        if (!e.error) {\n            update(e.manifest);\n        } else if (e.error.code === Errors.MANIFEST_LOADER_PARSING_FAILURE_ERROR_CODE) {\n            errHandler.error(e.error);\n        }\n    }\n\n    function onPlaybackStarted (/*e*/) {\n        isPaused = false;\n        startManifestRefreshTimer();\n    }\n\n    function onPlaybackPaused(/*e*/) {\n        isPaused = true;\n        stopManifestRefreshTimer();\n    }\n\n    function onStreamsComposed(/*e*/) {\n        // When streams are ready we can consider manifest update completed. Resolve the update promise.\n        isUpdating = false;\n    }\n\n    instance = {\n        initialize: initialize,\n        setManifest: setManifest,\n        refreshManifest: refreshManifest,\n        setConfig: setConfig,\n        reset: reset\n    };\n\n    setup();\n    return instance;\n}\nManifestUpdater.__dashjs_factory_name = 'ManifestUpdater';\nexport default FactoryMaker.getClassFactory(ManifestUpdater);\n"]}