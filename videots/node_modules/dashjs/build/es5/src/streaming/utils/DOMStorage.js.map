{"version":3,"sources":["../../../../../src/streaming/utils/DOMStorage.js"],"names":["legacyKeysAndReplacements","oldKey","newKey","LOCAL_STORAGE_BITRATE_KEY_TEMPLATE","LOCAL_STORAGE_SETTINGS_KEY_TEMPLATE","STORAGE_TYPE_LOCAL","STORAGE_TYPE_SESSION","LAST_BITRATE","LAST_MEDIA_SETTINGS","DOMStorage","config","context","settings","instance","logger","supported","setup","getInstance","getLogger","translateLegacyKeys","isSupported","type","undefined","testKey","testValue","storage","window","error","warn","message","setItem","removeItem","forEach","value","localStorage","getItem","entry","e","getTimestamp","ten_minutes_ms","Math","round","Date","getTime","canStore","storageType","key","get","streaming","enabled","checkConfig","Error","Constants","MISSING_CONFIG_ERROR","getSavedMediaSettings","mediaSettings","replace","obj","JSON","parse","isExpired","parseInt","timestamp","lastMediaSettingsCachingInfo","ttl","getSavedBitrateSettings","savedBitrate","NaN","lastBitrateCachingInfo","bitrate","parseFloat","isNaN","debug","setSavedMediaSettings","stringify","setSavedBitrateSettings","toFixed","__dashjs_factory_name","factory","FactoryMaker","getSingletonFactory"],"mappings":"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","file":"DOMStorage.js","sourcesContent":["/**\n * The copyright in this software is being made available under the BSD License,\n * included below. This software may be subject to other third party and contributor\n * rights, including patent rights, and no such rights are granted under this license.\n *\n * Copyright (c) 2013, Dash Industry Forum.\n * All rights reserved.\n *\n * Redistribution and use in source and binary forms, with or without modification,\n * are permitted provided that the following conditions are met:\n *  * Redistributions of source code must retain the above copyright notice, this\n *  list of conditions and the following disclaimer.\n *  * Redistributions in binary form must reproduce the above copyright notice,\n *  this list of conditions and the following disclaimer in the documentation and/or\n *  other materials provided with the distribution.\n *  * Neither the name of Dash Industry Forum nor the names of its\n *  contributors may be used to endorse or promote products derived from this software\n *  without specific prior written permission.\n *\n *  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS AS IS AND ANY\n *  EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\n *  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.\n *  IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,\n *  INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT\n *  NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR\n *  PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,\n *  WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)\n *  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE\n *  POSSIBILITY OF SUCH DAMAGE.\n */\nimport FactoryMaker from '../../core/FactoryMaker';\nimport Debug from '../../core/Debug';\nimport Constants from '../constants/Constants';\n\nconst legacyKeysAndReplacements = [\n    { oldKey: 'dashjs_vbitrate',  newKey: 'dashjs_video_bitrate' },\n    { oldKey: 'dashjs_abitrate',  newKey: 'dashjs_audio_bitrate' },\n    { oldKey: 'dashjs_vsettings', newKey: 'dashjs_video_settings' },\n    { oldKey: 'dashjs_asettings', newKey: 'dashjs_audio_settings' }\n];\n\nconst LOCAL_STORAGE_BITRATE_KEY_TEMPLATE = 'dashjs_?_bitrate';\nconst LOCAL_STORAGE_SETTINGS_KEY_TEMPLATE = 'dashjs_?_settings';\n\nconst STORAGE_TYPE_LOCAL = 'localStorage';\nconst STORAGE_TYPE_SESSION = 'sessionStorage';\nconst LAST_BITRATE = 'lastBitrate';\nconst LAST_MEDIA_SETTINGS = 'lastMediaSettings';\n\nfunction DOMStorage(config) {\n\n    config = config || {};\n    const context = this.context;\n    const settings = config.settings;\n\n    let instance,\n        logger,\n        supported;\n\n    function setup() {\n        logger = Debug(context).getInstance().getLogger(instance);\n        translateLegacyKeys();\n    }\n\n    //type can be local, session\n    function isSupported(type) {\n        if (supported !== undefined) return supported;\n\n        supported = false;\n\n        const testKey = '1';\n        const testValue = '1';\n        let storage;\n\n        try {\n            if (typeof window !== 'undefined') {\n                storage = window[type];\n            }\n        } catch (error) {\n            logger.warn('DOMStorage access denied: ' + error.message);\n            return supported;\n        }\n\n        if (!storage || (type !== STORAGE_TYPE_LOCAL && type !== STORAGE_TYPE_SESSION)) {\n            return supported;\n        }\n\n        /* When Safari (OS X or iOS) is in private browsing mode, it appears as though localStorage is available, but trying to call setItem throws an exception.\n         http://stackoverflow.com/questions/14555347/html5-localstorage-error-with-safari-quota-exceeded-err-dom-exception-22-an\n\n         Check if the storage can be used\n         */\n        try {\n            storage.setItem(testKey, testValue);\n            storage.removeItem(testKey);\n            supported = true;\n        } catch (error) {\n            logger.warn('DOMStorage is supported, but cannot be used: ' + error.message);\n        }\n\n        return supported;\n    }\n\n    function translateLegacyKeys() {\n        if (isSupported(STORAGE_TYPE_LOCAL)) {\n            legacyKeysAndReplacements.forEach(entry => {\n                const value = localStorage.getItem(entry.oldKey);\n\n                if (value) {\n                    localStorage.removeItem(entry.oldKey);\n\n                    try {\n                        localStorage.setItem(entry.newKey, value);\n                    } catch (e) {\n                        logger.error(e.message);\n                    }\n                }\n            });\n        }\n    }\n\n    // Return current epoch time, ms, rounded to the nearest 10m to avoid fingerprinting user\n    function getTimestamp() {\n        const ten_minutes_ms = 60 * 1000 * 10;\n        return Math.round(new Date().getTime() / ten_minutes_ms) * ten_minutes_ms;\n    }\n\n    function canStore(storageType, key) {\n        return isSupported(storageType) && settings.get().streaming[key + 'CachingInfo'].enabled;\n    }\n\n    function checkConfig() {\n        if (!settings) {\n            throw new Error(Constants.MISSING_CONFIG_ERROR);\n        }\n    }\n\n    function getSavedMediaSettings(type) {\n        let mediaSettings = null;\n\n        checkConfig();\n        //Checks local storage to see if there is valid, non-expired media settings\n        if (canStore(STORAGE_TYPE_LOCAL, LAST_MEDIA_SETTINGS)) {\n            const key = LOCAL_STORAGE_SETTINGS_KEY_TEMPLATE.replace(/\\?/, type);\n            try {\n                const obj = JSON.parse(localStorage.getItem(key)) || {};\n                const isExpired = (new Date().getTime() - parseInt(obj.timestamp, 10)) >= settings.get().streaming.lastMediaSettingsCachingInfo.ttl || false;\n                mediaSettings = obj.settings;\n\n                if (isExpired) {\n                    localStorage.removeItem(key);\n                    mediaSettings = null;\n                }\n            } catch (e) {\n                return null;\n            }\n        }\n        return mediaSettings;\n    }\n\n    function getSavedBitrateSettings(type) {\n        let savedBitrate = NaN;\n\n        checkConfig();\n\n        //Checks local storage to see if there is valid, non-expired bit rate\n        //hinting from the last play session to use as a starting bit rate.\n        if (canStore(STORAGE_TYPE_LOCAL, LAST_BITRATE)) {\n            const key = LOCAL_STORAGE_BITRATE_KEY_TEMPLATE.replace(/\\?/, type);\n            try {\n                const obj = JSON.parse(localStorage.getItem(key)) || {};\n                const isExpired = (new Date().getTime() - parseInt(obj.timestamp, 10)) >= settings.get().streaming.lastBitrateCachingInfo.ttl || false;\n                const bitrate = parseFloat(obj.bitrate);\n\n                if (!isNaN(bitrate) && !isExpired) {\n                    savedBitrate = bitrate;\n                    logger.debug('Last saved bitrate for ' + type + ' was ' + bitrate);\n                } else if (isExpired) {\n                    localStorage.removeItem(key);\n                }\n            } catch (e) {\n                return null;\n            }\n        }\n        return savedBitrate;\n    }\n\n    function setSavedMediaSettings(type, value) {\n        if (canStore(STORAGE_TYPE_LOCAL, LAST_MEDIA_SETTINGS)) {\n            const key = LOCAL_STORAGE_SETTINGS_KEY_TEMPLATE.replace(/\\?/, type);\n            try {\n                localStorage.setItem(key, JSON.stringify({settings: value, timestamp: getTimestamp()}));\n            } catch (e) {\n                logger.error(e.message);\n            }\n        }\n    }\n\n    function setSavedBitrateSettings(type, bitrate) {\n        if (canStore(STORAGE_TYPE_LOCAL, LAST_BITRATE) && bitrate) {\n            const key = LOCAL_STORAGE_BITRATE_KEY_TEMPLATE.replace(/\\?/, type);\n            try {\n                localStorage.setItem(key, JSON.stringify({bitrate: bitrate.toFixed(3), timestamp: getTimestamp()}));\n            } catch (e) {\n                logger.error(e.message);\n            }\n        }\n    }\n\n    instance = {\n        getSavedBitrateSettings: getSavedBitrateSettings,\n        setSavedBitrateSettings: setSavedBitrateSettings,\n        getSavedMediaSettings: getSavedMediaSettings,\n        setSavedMediaSettings: setSavedMediaSettings\n    };\n\n    setup();\n    return instance;\n}\n\nDOMStorage.__dashjs_factory_name = 'DOMStorage';\nconst factory = FactoryMaker.getSingletonFactory(DOMStorage);\nexport default factory;\n"]}