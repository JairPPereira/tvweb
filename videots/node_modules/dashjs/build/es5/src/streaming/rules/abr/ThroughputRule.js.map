{"version":3,"sources":["../../../../../../src/streaming/rules/abr/ThroughputRule.js"],"names":["ThroughputRule","config","context","dashMetrics","instance","logger","setup","getInstance","getLogger","checkConfig","hasOwnProperty","Error","Constants","MISSING_CONFIG_ERROR","getMaxIndex","rulesContext","switchRequest","create","mediaInfo","getMediaInfo","mediaType","getMediaType","bufferStateVO","getLatestBufferInfoVO","MetricsConstants","BUFFER_STATE","scheduleController","getScheduleController","abrController","getAbrController","streamInfo","getStreamInfo","isDynamic","manifestInfo","throughputHistory","getThroughputHistory","throughput","getSafeAverageThroughput","latency","getAverageLatency","useBufferOccupancyABR","isNaN","getAbandonmentStateFor","ABANDON_LOAD","state","BUFFER_LOADED","quality","getQualityForBitrate","setTimeToLoadDelay","debug","Math","round","reason","reset","__dashjs_factory_name","FactoryMaker","getClassFactory"],"mappings":"sEA8BA,wD,yDACA,0C,2CACA,+C,2DACA,oD,mDACA,kE,oJAEA,QAASA,eAAT,CAAwBC,MAAxB,CAAgC,CAE5BA,OAASA,QAAU,EAAnB,CACA,GAAMC,SAAU,KAAKA,OAArB,CACA,GAAMC,aAAcF,OAAOE,WAA3B,CAEA,GAAIC,gBAAJ,CACIC,aADJ,CAGA,QAASC,MAAT,EAAiB,CACbD,OAAS,oBAAMH,OAAN,EAAeK,WAAf,GAA6BC,SAA7B,CAAuCJ,QAAvC,CAAT,CACH,CAED,QAASK,YAAT,EAAuB,CACnB,GAAI,CAACN,WAAD,EAAgB,CAACA,YAAYO,cAAZ,CAA2B,uBAA3B,CAArB,CAA0E,CACtE,KAAM,IAAIC,MAAJ,CAAUC,oBAAUC,oBAApB,CAAN,CACH,CACJ,CAED,QAASC,YAAT,CAAqBC,YAArB,CAAmC,CAC/B,GAAMC,eAAgB,4BAAcd,OAAd,EAAuBe,MAAvB,EAAtB,CAEA,GAAI,CAACF,YAAD,EAAiB,CAACA,aAAaL,cAAb,CAA4B,cAA5B,CAAlB,EAAiE,CAACK,aAAaL,cAAb,CAA4B,cAA5B,CAAlE,EAAiH,CAACK,aAAaL,cAAb,CAA4B,uBAA5B,CAAlH,EACA,CAACK,aAAaL,cAAb,CAA4B,kBAA5B,CADD,EACoD,CAACK,aAAaL,cAAb,CAA4B,uBAA5B,CADzD,CAC+G,CAC3G,MAAOM,cAAP,CACH,CAEDP,cAEA,GAAMS,WAAYH,aAAaI,YAAb,EAAlB,CACA,GAAMC,WAAYL,aAAaM,YAAb,EAAlB,CACA,GAAMC,eAAgBnB,YAAYoB,qBAAZ,CAAkCH,SAAlC,CAA6C,IAA7C,CAAmDI,2BAAiBC,YAApE,CAAtB,CACA,GAAMC,oBAAqBX,aAAaY,qBAAb,EAA3B,CACA,GAAMC,eAAgBb,aAAac,gBAAb,EAAtB,CACA,GAAMC,YAAaf,aAAagB,aAAb,EAAnB,CACA,GAAMC,WAAYF,YAAcA,WAAWG,YAAzB,CAAwCH,WAAWG,YAAX,CAAwBD,SAAhE,CAA4E,IAA9F,CACA,GAAME,mBAAoBN,cAAcO,oBAAd,EAA1B,CACA,GAAMC,YAAaF,kBAAkBG,wBAAlB,CAA2CjB,SAA3C,CAAsDY,SAAtD,CAAnB,CACA,GAAMM,SAAUJ,kBAAkBK,iBAAlB,CAAoCnB,SAApC,CAAhB,CACA,GAAMoB,uBAAwBzB,aAAayB,qBAAb,EAA9B,CAGA,GAAIC,MAAML,UAAN,GAAqB,CAACd,aAAtB,EAAuCkB,qBAA3C,CAAkE,CAC9D,MAAOxB,cAAP,CACH,CAED,GAAIY,cAAcc,sBAAd,CAAqCtB,SAArC,IAAoDI,2BAAiBmB,YAAzE,CAAuF,CACnF,GAAIrB,cAAcsB,KAAd,GAAwBpB,2BAAiBqB,aAAzC,EAA0Db,SAA9D,CAAyE,CACrEhB,cAAc8B,OAAd,CAAwBlB,cAAcmB,oBAAd,CAAmC7B,SAAnC,CAA8CkB,UAA9C,CAA0DE,OAA1D,CAAxB,CACAZ,mBAAmBsB,kBAAnB,CAAsC,CAAtC,EACA3C,OAAO4C,KAAP,CAAa,IAAM7B,SAAN,CAAkB,gCAA/B,CAAiEJ,cAAc8B,OAA/E,CAAwF,oBAAxF,CAA8GI,KAAKC,KAAL,CAAWf,UAAX,CAA9G,CAAsI,MAAtI,EACApB,cAAcoC,MAAd,CAAuB,CAAChB,WAAYA,UAAb,CAAyBE,QAASA,OAAlC,CAAvB,CACH,CACJ,CAED,MAAOtB,cAAP,CACH,CAED,QAASqC,MAAT,EAAiB,CACb;AACH,CAEDjD,SAAW,CACPU,YAAaA,WADN,CAEPuC,MAAOA,KAFA,CAAX,CAKA/C,QAEA,MAAOF,SAAP,CACH,CA1GD;;;;;;;;;;;;;;;;;;;;;;;;;;;;;GA4GAJ,eAAesD,qBAAf,CAAuC,gBAAvC,C,gBACeC,uBAAaC,eAAb,CAA6BxD,cAA7B,C","file":"ThroughputRule.js","sourcesContent":["/**\n * The copyright in this software is being made available under the BSD License,\n * included below. This software may be subject to other third party and contributor\n * rights, including patent rights, and no such rights are granted under this license.\n *\n * Copyright (c) 2013, Dash Industry Forum.\n * All rights reserved.\n *\n * Redistribution and use in source and binary forms, with or without modification,\n * are permitted provided that the following conditions are met:\n *  * Redistributions of source code must retain the above copyright notice, this\n *  list of conditions and the following disclaimer.\n *  * Redistributions in binary form must reproduce the above copyright notice,\n *  this list of conditions and the following disclaimer in the documentation and/or\n *  other materials provided with the distribution.\n *  * Neither the name of Dash Industry Forum nor the names of its\n *  contributors may be used to endorse or promote products derived from this software\n *  without specific prior written permission.\n *\n *  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS AS IS AND ANY\n *  EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\n *  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.\n *  IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,\n *  INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT\n *  NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR\n *  PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,\n *  WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)\n *  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE\n *  POSSIBILITY OF SUCH DAMAGE.\n */\nimport FactoryMaker from '../../../core/FactoryMaker';\nimport Debug from '../../../core/Debug';\nimport SwitchRequest from '../SwitchRequest';\nimport Constants from '../../constants/Constants';\nimport MetricsConstants from '../../constants/MetricsConstants';\n\nfunction ThroughputRule(config) {\n\n    config = config || {};\n    const context = this.context;\n    const dashMetrics = config.dashMetrics;\n\n    let instance,\n        logger;\n\n    function setup() {\n        logger = Debug(context).getInstance().getLogger(instance);\n    }\n\n    function checkConfig() {\n        if (!dashMetrics || !dashMetrics.hasOwnProperty('getLatestBufferInfoVO')) {\n            throw new Error(Constants.MISSING_CONFIG_ERROR);\n        }\n    }\n\n    function getMaxIndex(rulesContext) {\n        const switchRequest = SwitchRequest(context).create();\n\n        if (!rulesContext || !rulesContext.hasOwnProperty('getMediaInfo') || !rulesContext.hasOwnProperty('getMediaType') || !rulesContext.hasOwnProperty('useBufferOccupancyABR') ||\n            !rulesContext.hasOwnProperty('getAbrController') || !rulesContext.hasOwnProperty('getScheduleController')) {\n            return switchRequest;\n        }\n\n        checkConfig();\n\n        const mediaInfo = rulesContext.getMediaInfo();\n        const mediaType = rulesContext.getMediaType();\n        const bufferStateVO = dashMetrics.getLatestBufferInfoVO(mediaType, true, MetricsConstants.BUFFER_STATE);\n        const scheduleController = rulesContext.getScheduleController();\n        const abrController = rulesContext.getAbrController();\n        const streamInfo = rulesContext.getStreamInfo();\n        const isDynamic = streamInfo && streamInfo.manifestInfo ? streamInfo.manifestInfo.isDynamic : null;\n        const throughputHistory = abrController.getThroughputHistory();\n        const throughput = throughputHistory.getSafeAverageThroughput(mediaType, isDynamic);\n        const latency = throughputHistory.getAverageLatency(mediaType);\n        const useBufferOccupancyABR = rulesContext.useBufferOccupancyABR();\n\n\n        if (isNaN(throughput) || !bufferStateVO || useBufferOccupancyABR) {\n            return switchRequest;\n        }\n\n        if (abrController.getAbandonmentStateFor(mediaType) !== MetricsConstants.ABANDON_LOAD) {\n            if (bufferStateVO.state === MetricsConstants.BUFFER_LOADED || isDynamic) {\n                switchRequest.quality = abrController.getQualityForBitrate(mediaInfo, throughput, latency);\n                scheduleController.setTimeToLoadDelay(0);\n                logger.debug('[' + mediaType + '] requesting switch to index: ', switchRequest.quality, 'Average throughput', Math.round(throughput), 'kbps');\n                switchRequest.reason = {throughput: throughput, latency: latency};\n            }\n        }\n\n        return switchRequest;\n    }\n\n    function reset() {\n        // no persistent information to reset\n    }\n\n    instance = {\n        getMaxIndex: getMaxIndex,\n        reset: reset\n    };\n\n    setup();\n\n    return instance;\n}\n\nThroughputRule.__dashjs_factory_name = 'ThroughputRule';\nexport default FactoryMaker.getClassFactory(ThroughputRule);\n"]}