{"version":3,"sources":["../../../../../src/streaming/controllers/EventController.js"],"names":["EventController","MPD_RELOAD_SCHEME","MPD_RELOAD_VALUE","MPD_CALLBACK_SCHEME","MPD_CALLBACK_VALUE","context","eventBus","getInstance","instance","logger","inlineEvents","inbandEvents","activeEvents","eventInterval","refreshDelay","lastEventTimerCall","manifestUpdater","playbackController","isStarted","setup","getLogger","resetInitialSettings","Date","now","checkConfig","Error","stop","clearInterval","start","debug","isNaN","setInterval","onEventTimer","addInlineEvents","values","i","length","event","id","addInbandEvents","eventStream","schemeIdUri","undefined","handleManifestReloadEvent","value","timescale","validUntil","presentationTime","newDuration","NaN","duration","info","trigger","Events","MANIFEST_VALIDITY_CHANGED","newManifestValidAfter","removeEvents","currentVideoTime","getTime","eventIds","Object","keys","eventId","curr","presentationTimeThreshold","Math","max","triggerEvents","refreshManifest","sendCallbackRequest","url","loader","create","load","method","request","responseType","events","presentationTimeDelta","messageData","setConfig","config","reset","__dashjs_factory_name","FactoryMaker","getClassFactory"],"mappings":"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","file":"EventController.js","sourcesContent":["/**\n * The copyright in this software is being made available under the BSD License,\n * included below. This software may be subject to other third party and contributor\n * rights, including patent rights, and no such rights are granted under this license.\n *\n * Copyright (c) 2013, Dash Industry Forum.\n * All rights reserved.\n *\n * Redistribution and use in source and binary forms, with or without modification,\n * are permitted provided that the following conditions are met:\n *  * Redistributions of source code must retain the above copyright notice, this\n *  list of conditions and the following disclaimer.\n *  * Redistributions in binary form must reproduce the above copyright notice,\n *  this list of conditions and the following disclaimer in the documentation and/or\n *  other materials provided with the distribution.\n *  * Neither the name of Dash Industry Forum nor the names of its\n *  contributors may be used to endorse or promote products derived from this software\n *  without specific prior written permission.\n *\n *  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS AS IS AND ANY\n *  EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\n *  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.\n *  IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,\n *  INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT\n *  NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR\n *  PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,\n *  WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)\n *  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE\n *  POSSIBILITY OF SUCH DAMAGE.\n */\n\nimport FactoryMaker from '../../core/FactoryMaker';\nimport Debug from '../../core/Debug';\nimport EventBus from '../../core/EventBus';\nimport Events from '../../core/events/Events';\nimport XHRLoader from '../net/XHRLoader';\n\nfunction EventController() {\n\n    const MPD_RELOAD_SCHEME = 'urn:mpeg:dash:event:2012';\n    const MPD_RELOAD_VALUE = 1;\n\n    const MPD_CALLBACK_SCHEME = 'urn:mpeg:dash:event:callback:2015';\n    const MPD_CALLBACK_VALUE = 1;\n\n    const context = this.context;\n    const eventBus = EventBus(context).getInstance();\n\n    let instance,\n        logger,\n        inlineEvents, // Holds all Inline Events not triggered yet\n        inbandEvents, // Holds all Inband Events not triggered yet\n        activeEvents, // Holds all Events currently running\n        eventInterval, // variable holding the setInterval\n        refreshDelay, // refreshTime for the setInterval\n        lastEventTimerCall,\n        manifestUpdater,\n        playbackController,\n        isStarted;\n\n    function setup() {\n        logger = Debug(context).getInstance().getLogger(instance);\n        resetInitialSettings();\n    }\n\n    function resetInitialSettings() {\n        isStarted = false;\n        inlineEvents = {};\n        inbandEvents = {};\n        activeEvents = {};\n        eventInterval = null;\n        refreshDelay = 100;\n        lastEventTimerCall = Date.now() / 1000;\n    }\n\n    function checkConfig() {\n        if (!manifestUpdater || !playbackController) {\n            throw new Error('setConfig function has to be called previously');\n        }\n    }\n\n    function stop() {\n        if (eventInterval !== null && isStarted) {\n            clearInterval(eventInterval);\n            eventInterval = null;\n            isStarted = false;\n        }\n    }\n\n    function start() {\n        checkConfig();\n        logger.debug('Start Event Controller');\n        if (!isStarted && !isNaN(refreshDelay)) {\n            isStarted = true;\n            eventInterval = setInterval(onEventTimer, refreshDelay);\n        }\n    }\n\n    /**\n     * Add events to the eventList. Events that are not in the mpd anymore but not triggered yet will still be deleted\n     * @param {Array.<Object>} values\n     */\n    function addInlineEvents(values) {\n        checkConfig();\n\n        inlineEvents = {};\n\n        if (values) {\n            for (let i = 0; i < values.length; i++) {\n                let event = values[i];\n                inlineEvents[event.id] = event;\n                logger.debug('Add inline event with id ' + event.id);\n            }\n        }\n        logger.debug('Added ' + values.length + ' inline events');\n    }\n\n    /**\n     * i.e. processing of any one event message box with the same id is sufficient\n     * @param {Array.<Object>} values\n     */\n    function addInbandEvents(values) {\n        checkConfig();\n\n        for (let i = 0; i < values.length; i++) {\n            let event = values[i];\n            if (!(event.id in inbandEvents)) {\n                if (event.eventStream.schemeIdUri === MPD_RELOAD_SCHEME && inbandEvents[event.id] === undefined) {\n                    handleManifestReloadEvent(event);\n                }\n                inbandEvents[event.id] = event;\n                logger.debug('Add inband event with id ' + event.id);\n            } else {\n                logger.debug('Repeated event with id ' + event.id);\n            }\n        }\n    }\n\n    function handleManifestReloadEvent(event) {\n        if (event.eventStream.value == MPD_RELOAD_VALUE) {\n            const timescale = event.eventStream.timescale || 1;\n            const validUntil = event.presentationTime / timescale;\n            let newDuration;\n            if (event.presentationTime == 0xFFFFFFFF) {//0xFF... means remaining duration unknown\n                newDuration = NaN;\n            } else {\n                newDuration = (event.presentationTime + event.duration) / timescale;\n            }\n            logger.info('Manifest validity changed: Valid until: ' + validUntil + '; remaining duration: ' + newDuration);\n            eventBus.trigger(Events.MANIFEST_VALIDITY_CHANGED, {\n                id: event.id,\n                validUntil: validUntil,\n                newDuration: newDuration,\n                newManifestValidAfter: NaN //event.message_data - this is an arraybuffer with a timestring in it, but not used yet\n            });\n        }\n    }\n\n    /**\n     * Remove events which are over from the list\n     */\n    function removeEvents() {\n        if (activeEvents) {\n            let currentVideoTime = playbackController.getTime();\n            let eventIds = Object.keys(activeEvents);\n\n            for (let i = 0; i < eventIds.length; i++) {\n                let eventId = eventIds[i];\n                let curr = activeEvents[eventId];\n                if (curr !== null && (curr.duration + curr.presentationTime) / curr.eventStream.timescale < currentVideoTime) {\n                    logger.debug('Remove Event ' + eventId + ' at time ' + currentVideoTime);\n                    curr = null;\n                    delete activeEvents[eventId];\n                }\n            }\n        }\n    }\n\n    /**\n     * Iterate through the eventList and trigger/remove the events\n     */\n    function onEventTimer() {\n        var currentVideoTime = playbackController.getTime();\n        var presentationTimeThreshold = (currentVideoTime - lastEventTimerCall);\n        lastEventTimerCall = currentVideoTime;\n\n        presentationTimeThreshold = Math.max(0,presentationTimeThreshold);\n\n        triggerEvents(inbandEvents, presentationTimeThreshold, currentVideoTime);\n        triggerEvents(inlineEvents, presentationTimeThreshold, currentVideoTime);\n        removeEvents();\n    }\n\n    function refreshManifest() {\n        checkConfig();\n        manifestUpdater.refreshManifest();\n    }\n\n    function sendCallbackRequest(url) {\n        let loader = XHRLoader(context).create({});\n        loader.load({\n            method: 'get',\n            url: url,\n            request: {\n                responseType: 'arraybuffer'\n            }});\n    }\n\n    function triggerEvents(events, presentationTimeThreshold, currentVideoTime) {\n        var presentationTime;\n\n        /* == Trigger events that are ready == */\n        if (events) {\n            let eventIds = Object.keys(events);\n            for (let i = 0; i < eventIds.length; i++) {\n                let eventId = eventIds[i];\n                let curr = events[eventId];\n\n                if (curr !== undefined) {\n                    presentationTime = curr.presentationTime / curr.eventStream.timescale;\n                    if (presentationTime === 0 || (presentationTime <= currentVideoTime && presentationTime + presentationTimeThreshold > currentVideoTime)) {\n                        logger.debug('Start Event ' + eventId + ' at ' + currentVideoTime);\n                        if (curr.duration > 0) {\n                            activeEvents[eventId] = curr;\n                        }\n                        if (curr.eventStream.schemeIdUri == MPD_RELOAD_SCHEME && curr.eventStream.value == MPD_RELOAD_VALUE) {\n                            if (curr.duration !== 0 || curr.presentationTimeDelta !== 0) { //If both are set to zero, it indicates the media is over at this point. Don't reload the manifest.\n                                refreshManifest();\n                            }\n                        } else if (curr.eventStream.schemeIdUri == MPD_CALLBACK_SCHEME && curr.eventStream.value == MPD_CALLBACK_VALUE) {\n                            sendCallbackRequest(curr.messageData);\n                        } else {\n                            eventBus.trigger(curr.eventStream.schemeIdUri, {event: curr});\n                        }\n                        delete events[eventId];\n                    }\n                    else if (presentationTime <= currentVideoTime - presentationTimeThreshold) {\n                        delete events[eventId];\n                    }\n                }\n            }\n        }\n    }\n\n    function setConfig(config) {\n        if (!config) return;\n\n        if (config.manifestUpdater) {\n            manifestUpdater = config.manifestUpdater;\n        }\n\n        if (config.playbackController) {\n            playbackController = config.playbackController;\n        }\n    }\n\n    function reset() {\n        stop();\n        resetInitialSettings();\n    }\n\n    instance = {\n        addInlineEvents: addInlineEvents,\n        addInbandEvents: addInbandEvents,\n        stop: stop,\n        start: start,\n        setConfig: setConfig,\n        reset: reset\n    };\n\n    setup();\n\n    return instance;\n}\n\nEventController.__dashjs_factory_name = 'EventController';\nexport default FactoryMaker.getClassFactory(EventController);\n"]}