{"version":3,"sources":["../../../../../src/streaming/controllers/BaseURLController.js"],"names":["BaseURLController","instance","adapter","context","eventBus","getInstance","urlUtils","baseURLTreeModel","baseURLSelector","onBlackListChanged","e","invalidateSelectedIndexes","entry","setup","create","on","Events","SERVICE_LOCATION_BLACKLIST_CHANGED","setConfig","config","update","manifest","chooseSelector","getIsDVB","resolve","path","baseUrls","getForPath","baseUrl","reduce","p","c","b","select","isRelative","url","serviceLocation","availabilityTimeOffset","availabilityTimeComplete","BaseURL","reset","initialize","data","__dashjs_factory_name","FactoryMaker","getSingletonFactory"],"mappings":"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","file":"BaseURLController.js","sourcesContent":["/**\n * The copyright in this software is being made available under the BSD License,\n * included below. This software may be subject to other third party and contributor\n * rights, including patent rights, and no such rights are granted under this license.\n *\n * Copyright (c) 2013, Dash Industry Forum.\n * All rights reserved.\n *\n * Redistribution and use in source and binary forms, with or without modification,\n * are permitted provided that the following conditions are met:\n *  * Redistributions of source code must retain the above copyright notice, this\n *  list of conditions and the following disclaimer.\n *  * Redistributions in binary form must reproduce the above copyright notice,\n *  this list of conditions and the following disclaimer in the documentation and/or\n *  other materials provided with the distribution.\n *  * Neither the name of Dash Industry Forum nor the names of its\n *  contributors may be used to endorse or promote products derived from this software\n *  without specific prior written permission.\n *\n *  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS AS IS AND ANY\n *  EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\n *  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.\n *  IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,\n *  INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT\n *  NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR\n *  PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,\n *  WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)\n *  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE\n *  POSSIBILITY OF SUCH DAMAGE.\n */\n\nimport BaseURLTreeModel from '../models/BaseURLTreeModel';\nimport BaseURLSelector from '../utils/BaseURLSelector';\nimport URLUtils from '../utils/URLUtils';\nimport BaseURL from '../../dash/vo/BaseURL';\nimport FactoryMaker from '../../core/FactoryMaker';\nimport EventBus from '../../core/EventBus';\nimport Events from '../../core/events/Events';\n\nfunction BaseURLController() {\n\n    let instance,\n        adapter;\n\n    const context = this.context;\n    const eventBus = EventBus(context).getInstance();\n    const urlUtils = URLUtils(context).getInstance();\n\n    let baseURLTreeModel,\n        baseURLSelector;\n\n    function onBlackListChanged(e) {\n        baseURLTreeModel.invalidateSelectedIndexes(e.entry);\n    }\n\n    function setup() {\n        baseURLTreeModel = BaseURLTreeModel(context).create();\n        baseURLSelector = BaseURLSelector(context).create();\n\n        eventBus.on(Events.SERVICE_LOCATION_BLACKLIST_CHANGED, onBlackListChanged, instance);\n    }\n\n    function setConfig(config) {\n        if (config.baseURLTreeModel) {\n            baseURLTreeModel = config.baseURLTreeModel;\n        }\n\n        if (config.baseURLSelector) {\n            baseURLSelector = config.baseURLSelector;\n        }\n\n        if (config.adapter) {\n            adapter = config.adapter;\n        }\n    }\n\n    function update(manifest) {\n        baseURLTreeModel.update(manifest);\n        baseURLSelector.chooseSelector(adapter.getIsDVB(manifest));\n    }\n\n    function resolve(path) {\n        const baseUrls = baseURLTreeModel.getForPath(path);\n\n        const baseUrl = baseUrls.reduce((p, c) => {\n            const b = baseURLSelector.select(c);\n\n            if (b) {\n                if (!urlUtils.isRelative(b.url)) {\n                    p.url = b.url;\n                    p.serviceLocation = b.serviceLocation;\n                } else {\n                    p.url = urlUtils.resolve(b.url, p.url);\n                }\n                p.availabilityTimeOffset = b.availabilityTimeOffset;\n                p.availabilityTimeComplete = b.availabilityTimeComplete;\n            } else {\n                return new BaseURL();\n            }\n\n            return p;\n        }, new BaseURL());\n\n        if (!urlUtils.isRelative(baseUrl.url)) {\n            return baseUrl;\n        }\n    }\n\n    function reset() {\n        baseURLTreeModel.reset();\n        baseURLSelector.reset();\n    }\n\n    function initialize(data) {\n\n        // report config to baseURLTreeModel and baseURLSelector\n        baseURLTreeModel.setConfig({\n            adapter: adapter\n        });\n\n        update(data);\n    }\n\n    instance = {\n        reset: reset,\n        initialize: initialize,\n        resolve: resolve,\n        setConfig: setConfig\n    };\n\n    setup();\n\n    return instance;\n}\n\nBaseURLController.__dashjs_factory_name = 'BaseURLController';\nexport default FactoryMaker.getSingletonFactory(BaseURLController);\n"]}